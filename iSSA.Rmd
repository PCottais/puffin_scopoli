---
title: "Integrated step selection analysis (iSSA)"
author: "Pierre Cottais & An Hoàng"
date: "25/01/2022"
output: 
  pdf_document: 
    extra_dependencies: ["float"]
    toc: yes
    number_sections: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,
                      results = "hide")
```


```{r packages}
library(tidyverse)
library(ggmap)
# library(sf)
library(lubridate)
library(amt)
library(stargazer)
```


# Data processing
```{r}
# oceanography dataset
load("CALDIO_MPE_2021/generalisation datasets/grid_oceano_2011.Rdata")
load("CALDIO_MPE_2021/generalisation datasets/grid_oceano_Date_2011.Rdata")

# Scopoli's sheawater datasets
load("CALDIO_MPE_2021/training datasets/CALDIO_2011_oceano.Rdata")
load("CALDIO_MPE_2021/training datasets/CALDIO_2012_oceano.Rdata")

# load functions
source("functions.R")
```


Work with Shoreline / Coastline shapefiles
```{r eval=FALSE, include=FALSE}
# europe <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf",
#                                      continent = "Europe")
# 
# mediterra <- europe %>% 
#   filter(admin %in% c("France", "Italy", "Spain")) %>%  
#   st_crop(xmin = 3, xmax = 11, ymin = 40, ymax = 45)
# 
# mediterra %>% 
#   # st_transform(crs = 2154) %>% 
#   ggplot() + geom_sf() + 
#   geom_point(data = grd[!is.na(grd$Bathy) & !is.na(grd$SST1),],
#              aes(x = Longitude, y = Latitude), size = 0.2)
# 
# df_union_cast <- mediterra$geometry %>% 
#   st_cast("MULTIPOLYGON")
# 
# plot(df_union_cast)
```

Remove birds near the coast boundary
```{r message=FALSE, warning=FALSE}
grd <- grid_oceano[[1]]
mediterranean  <- make_bbox(lat = Latitude, lon = Longitude, data = grd)
map <- get_map(location = mediterranean) %>% ggmap()
df_grid <- grd %>% filter(!is.na(SST1), !is.na(Bathy))
map + geom_point(data = df_grid, aes(x = Longitude, y = Latitude), size = 0.1)
```

Steps of Giraglia colony
```{r eval=FALSE, include=FALSE}
# observed + available steps
start <- Sys.time()
stps <- iSSA_steps(colony = "Giraglia", year = 2011,
             # covariates = colnames(grid_oceano[[1]][,8:41]))
             covariates = c("Bathy", "GBathy", "SST28", "GSST28", "Var_SST28",
                            "SLA1", "VEL7", "logCHLA28", "GCHLA28"))
end <- Sys.time()
print(end-start)

# iSSA conditional regression model
mod_G <- stps %>% amt::fit_issf(case_ ~ sl_ + ta_ + log_sl + Bathy + GBathy +
                                  SST28 + GSST28 + Var_SST28 + SLA1 + VEL7 +
                                  logCHLA28 + GCHLA28 + strata(step_id_))
mod_G$model
```

# Build steps (observed and available) and the 4 models
```{r eval=FALSE, include=FALSE}
# initialisation
steps <- list()
models <- list()

# running the analysis
start <- Sys.time()
for (site in unique(ALL2011$Site)){
  print(site)
  stps <- iSSA_steps(colony = site, year = 2011,
                      covariates = c("Bathy", "GBathy", "SST28", "GSST28", "Var_SST28",
                                     "SLA1", "VEL7", "logCHLA28", "GCHLA28"))
  # # standardizing covariates
  # stps <- scale(stps[, 9:17])
  
  # saving steps dataframe
  steps[[site]] <- stps
  
  # saving models
  models[[site]] <- stps %>% amt::fit_issf(case_ ~ sl_ + ta_ + log_sl + Bathy + GBathy +
                                  SST28 + GSST28 + Var_SST28 + SLA1 + VEL7 +
                                  logCHLA28 + GCHLA28 + strata(step_id_))
}
end <- Sys.time()
print(end-start)
```


# Loading models and steps generated before
```{r}
load("issa_env.RData")
```



# compare the 4 models (i.e. colonies) with utilisation distribution

Oceanographic grid (date: 28/06/2011)
```{r}
grd <- grid_oceano[[1]]
```


```{r}
colony <- "Riou"
print(colony)
modR <- models$Riou$model
```

```{r echo=FALSE, results='asis'}
stargazer(modR, type = "latex",
          title = paste("Résumé du modèle de régression logistique conditionnel pour la colonie", colony),
          summary = FALSE)
```

```{r message=FALSE, warning=FALSE}
df <- ALL2011 %>% 
  filter(Site == colony)
mediterranean  <- make_bbox(lat = Latitude, lon = Longitude, data = df)
map <- get_map(location = mediterranean) %>% ggmap()
# df_grid <- grd %>% filter(!is.na(SST1), !is.na(Bathy))
map + geom_point(data = df, aes(x = Longitude, y = Latitude), size = 0.1)
```


```{r}
colony <- "Lavezzi"
print(colony)
modL <- models$Lavezzi$model
```

```{r echo=FALSE, results='asis'}
stargazer(modL, type = "latex",
          title = paste("Résumé du modèle de régression logistique conditionnel pour la colonie", colony),
          summary = FALSE)
```

There are too many steps removed because missing (. Let's investigate why.
```{r message=FALSE, warning=FALSE}
df <- ALL2011 %>% 
  filter(Site == colony)
mediterranean  <- make_bbox(lat = Latitude, lon = Longitude, data = df)
map <- get_map(location = mediterranean) %>% ggmap()
# df_grid <- grd %>% filter(!is.na(SST1), !is.na(Bathy))
map + geom_point(data = df, aes(x = Longitude, y = Latitude), size = 0.1)
```


```{r}
colony <- "Porquerolles"
print(colony)
modP <- models$Porquerolles$model
```

```{r echo=FALSE, results='asis'}
stargazer(modP, type = "latex",
          title = paste("Résumé du modèle de régression logistique conditionnel pour la colonie", colony),
          summary = FALSE)
```

```{r message=FALSE, warning=FALSE}
df <- ALL2011 %>% 
  filter(Site == colony)
mediterranean  <- make_bbox(lat = Latitude, lon = Longitude, data = df)
map <- get_map(location = mediterranean) %>% ggmap()
# df_grid <- grd %>% filter(!is.na(SST1), !is.na(Bathy))
map + geom_point(data = df, aes(x = Longitude, y = Latitude), size = 0.1)
```


```{r}
colony <- "Giraglia"
print(colony)
modG <- models$Giraglia$model
```

```{r echo=FALSE, results='asis'}
stargazer(modG, type = "latex",
          title = paste("Résumé du modèle de régression logistique conditionnel pour la colonie", colony),
          summary = FALSE)
```

```{r message=FALSE, warning=FALSE}
df <- ALL2011 %>% 
  filter(Site == colony)
mediterranean  <- make_bbox(lat = Latitude, lon = Longitude, data = df)
map <- get_map(location = mediterranean) %>% ggmap()
# df_grid <- grd %>% filter(!is.na(SST1), !is.na(Bathy))
map + geom_point(data = df, aes(x = Longitude, y = Latitude), size = 0.1)
```
